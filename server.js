const express=require('express');const path=require('path');const fs=require('fs');const bodyParser=require('body-parser');const session=require('express-session');const cookieParser=require('cookie-parser');const app=express();const PORT=process.env.PORT||3000;const DATA_DIR=path.join(__dirname,'data');const BOOKINGS_FILE=path.join(DATA_DIR,'bookings.json');const CONTACTS_FILE=path.join(DATA_DIR,'contacts.json');if(!fs.existsSync(DATA_DIR))fs.mkdirSync(DATA_DIR);if(!fs.existsSync(BOOKINGS_FILE))fs.writeFileSync(BOOKINGS_FILE,'[]');if(!fs.existsSync(CONTACTS_FILE))fs.writeFileSync(CONTACTS_FILE,'[]');function readJSON(f){try{return JSON.parse(fs.readFileSync(f));}catch(e){return []}}function writeJSON(f,d){fs.writeFileSync(f,JSON.stringify(d,null,2));}app.set('view engine','ejs');app.set('views',path.join(__dirname,'views'));app.use('/images',express.static(path.join(__dirname,'public','images')));app.use(express.static(path.join(__dirname,'public')));app.use(bodyParser.urlencoded({extended:true}));app.use(bodyParser.json());app.use(cookieParser());app.use(session({secret:process.env.SESSION_SECRET||'tellusmove_secret',resave:false,saveUninitialized:true}));app.get('/',(req,res)=>res.render('home'));app.get('/book',(req,res)=>res.render('book'));app.post('/preview',(req,res)=>{const data=req.body;res.render('preview',{data});});app.post('/confirm',(req,res)=>{const p=req.body;const bookings=readJSON(BOOKINGS_FILE);const id='TLM-'+Date.now().toString(36).toUpperCase().slice(0,6);const b={id,name:p.name,email:p.email,phone:p.phone,pickup:p.pickup,dropoff:p.dropoff,truckType:p.truckType,date:p.date,status:'pending',createdAt:new Date().toISOString()};bookings.push(b);writeJSON(BOOKINGS_FILE,bookings);res.redirect('/confirmed?bid='+encodeURIComponent(id));});app.get('/confirmed',(req,res)=>{const bid=req.query.bid||null;res.render('confirmed',{bid});});app.get('/track',(req,res)=>res.render('track'));app.post('/track',(req,res)=>{const id=req.body.bookingId;const bookings=readJSON(BOOKINGS_FILE);const found=bookings.find(b=>b.id===id);res.render('track',{result:found});});app.get('/schedules',(req,res)=>{const bookings=readJSON(BOOKINGS_FILE);res.render('schedules',{bookings});});app.get('/alerts',(req,res)=>res.render('alerts'));app.get('/about',(req,res)=>res.render('about'));app.get('/contact',(req,res)=>res.render('contact'));app.post('/contact',(req,res)=>{const {name,email,message}=req.body;const contacts=readJSON(CONTACTS_FILE);contacts.push({id:'C-'+Date.now().toString(36),name,email,message,createdAt:new Date().toISOString()});writeJSON(CONTACTS_FILE,contacts);res.render('contact',{success:true});});app.get('/admin',(req,res)=>res.render('admin-login'));app.post('/admin',(req,res)=>{const{username,password}=req.body;if(username==='gaurav'&&password==='gaurav'){req.session.isAdmin=true;return res.redirect('/admin/dashboard')}res.render('admin-login',{error:'Invalid credentials'});});app.get('/admin/dashboard',(req,res)=>{if(!req.session.isAdmin)return res.redirect('/admin');const bookings=readJSON(BOOKINGS_FILE);res.render('admin-dashboard',{bookings});});app.post('/admin/confirm/:id',(req,res)=>{if(!req.session.isAdmin)return res.redirect('/admin');const id=req.params.id;const bookings=readJSON(BOOKINGS_FILE);const idx=bookings.findIndex(b=>b.id===id);if(idx!==-1){bookings[idx].status='confirmed';writeJSON(BOOKINGS_FILE,bookings);}res.redirect('/admin/dashboard');});app.post('/admin/cancel/:id',(req,res)=>{if(!req.session.isAdmin)return res.redirect('/admin');const id=req.params.id;let bookings=readJSON(BOOKINGS_FILE);bookings=bookings.filter(b=>b.id!==id);writeJSON(BOOKINGS_FILE,bookings);res.redirect('/admin/dashboard');});app.get('/admin-logout',(req,res)=>{req.session.destroy(()=>res.redirect('/'));});app.get('/comingsoon',(req,res)=>res.render('coming-soon'));app.listen(PORT,()=>console.log('Server started on',PORT));